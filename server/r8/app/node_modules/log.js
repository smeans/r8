var levels = ['error', 'warn', 'info', 'debug', 'verbose'];
var buffer = [];
var listeners = [];
var max_buffer = 1000;

function write(level, args) {
  function objToString(o) {
    if (o instanceof Error) {
      return module.exports.level == 'debug' ? o.message + ': ' + o.stack : o.message;
    }

    return JSON.stringify(o);
  }

  if (levels.indexOf(level) > levels.indexOf(module.exports.level)) {
    return;
  }

  var message = args.reduce(function (p, c) {
    if (c == undefined) {
      return p + ': (undefined)';
    } else {
      return typeof c == 'object' ? (p ? p + ': ' + objToString(c) : objToString(c)) : (p ? p + ' ' + c.toString() : c.toString());
    }
  }, '');

  var ts = (new Date()).toISOString();
  console.log(ts + ': ' + level + ': ' + message);
  buffer.push({timestamp: ts, level, message});

  if (max_buffer >= 0 && buffer.length > max_buffer) {
    buffer.splice(0, buffer.length - max_buffer);
  }

  listeners.forEach(function (listener) {
    listener(ts, level, message);
  });
}

module.exports = {
  levels,
  debugging: () => module.exports.level == 'debug',
  level: process.env.LOG_LEVEL || 'info',
  add_listener: function (listener) { listeners.push(listener); },
  remove_listener: function (listener) {
    var i = listeners.indexOf(listener);
    if (i > -1) {
      listeners.splice(i, 1);
    }
  },
  write,
  error: function (message) { write('error', Array.from(arguments)); },
  warn: function (message) { write('warn', Array.from(arguments)); },
  info: function (message) { write('info', Array.from(arguments)); },
  debug: function (message) { write('debug', Array.from(arguments)); },
  verbose: function (message) { write('verbose', Array.from(arguments)); },
  buffer,
  max_buffer
};
