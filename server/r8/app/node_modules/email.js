const log = require('log');
const sgMail = require('@sendgrid/mail')

let emailEnabled = false;

if (process.env.SENDGRID_API_KEY) {
    sgMail.setApiKey(process.env.SENDGRID_API_KEY)
    emailEnabled = true;
} else {
    log.warn('email: no SENDGRID_API_KEY: email disabled');
}

const templates = {
    "confirmLogin": "d-1d2f980152e84d1c870fa6ac24e8dba9"
}

const defaultFrom = "support@quota.ws";

async function sendEmail(templateName, toEmail, params) {
    log.verbose('sendEmail', toEmail, params);

    if (!emailEnabled) {
        return true;
    }

    let resp = await await sgMail.send({
        "from": defaultFrom,
        "to": toEmail,
        "dynamic_template_data": params,
        "template_id": templates[templateName]
    });

    if (resp.length < 1) {
        return false;
    }

    resp = resp[0];

    return resp.statusCode >= 200 && resp.statusCode < 400;
}

module.exports = {
    sendEmail
}
