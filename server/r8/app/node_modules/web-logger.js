const log = require('log');
const db = require('db');
const config = require('config');
const au = require('apputil');

module.exports = function (options) {
    const collectionPrefix = options.collectionPrefix || 'webLogs';

    return function (req, res, next) {
        const ts = new Date();
        const collectionName = `${collectionPrefix}-${ts.getFullYear()}-${Math.floor(au.dayOfYear(ts)/7)}`;

        db.collection(collectionName).insertOne({
            request_ts: ts.getTime(),
            client_ip: req.headers['x-forwarded-for'] || req.connection.remoteAddress,
            method: req.method,
            url: req.url
        });

        if (log.debugging) {
            console.debug(`${ts.toISOString()} ${req.method} ${req.url}`);
        }

        next();
    }
}
