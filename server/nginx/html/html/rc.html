<script>
    'use strict';

    class RcElement extends PhElement {
        // credit https://stackoverflow.com/a/54532941/149407
        // but I feel this code is needlessly tricky
        closestElement(
            selector,      // selector like in .closest()
            base = this,   // extra functionality to skip a parent
            __Closest = (el, found = el && el.closest(selector)) =>
                !el || el === document || el === window
                    ? null // standard .closest() returns null for non-found selectors also
                    : found
                        ? found // found a selector INside this element
                        : __Closest(el.getRootNode().host) // recursion!! break out to parent DOM
        ) {
            return __Closest(base);
        }

        fireEvent(eventName, detail) {
          var o = {bubbles: true, composed: true};

          if (detail) {
            o.detail = detail;
          }

          this.dispatchEvent(new CustomEvent(eventName, o));
        }
    }
</script>
<ph-components>
    <template name="x-button">
        <style>
            :host {
                display: inline-block;
            }

            button {
                width: 100%;
                height: 100%;
                font-family: inherit;
                font-size: 100%;
                background: #0000;
                line-height: 1.15;
                margin: 0;
                overflow: visible;
                text-transform: none;
                -webkit-appearance: button;
                border: none;
            }

            :host(.round),
            :host(.sm-round),
            :host(.lg-round) {
                background: var(--accent-bg);
                border-radius: 50%;
            }

            :host(.round:hover),
            :host(.sm-round:hover),
            :host(.lg-round:hover) {
                background: var(--accent-bg-lt);
            }

            :host(.sm-round) {
                width: var(--small);
                height: var(--small);
            }

            :host(.lg-round) {
                width: var(--large);
                height: var(--large);
            }

            :host(.round) button,
            :host(.sm-round) button,
            :host(.lg-round) button {
                fill: #fff;
            }
        </style>
        <button><slot></slot></button>
        <script>
            class XButton extends ExpressiveElement {

            }
        </script>
    </template>

    <template name="x-tiles">
        <style>
            :host {
                display: flex;
            }
        </style>
        <slot></slot>
        <script>
            class XTiles extends ExpressiveElement {

            }
        </script>
    </template>

    <template name="x-tile">
        <style>
            :host {
                display: flex;
            }
        </style>
        <slot></slot>
        <script>
            class XTile extends ExpressiveElement {

            }
        </script>
    </template>

    <template name="rc-package-tile">
        <style>
            :host {
                align-items: center;
                justify-content: center;

                opacity: 1;
            }

            :host(.closing),
            :host(.closing) x-tile {
                animation-duration: var(--faster);
                animation-timing-function: ease-in;
                animation-name: closing;
            }

            @keyframes closing {
                from  {
                    opacity: 1;
                }

                20% {
                    max-height: var(--big-tile-h);
                    max-width: var(--big-tile-w);
                    transform: scale(1);
                }

                to {
                    opacity: 0;
                    max-height: 0;
                    max-width: 0;
                    transform: scale(0);
                }
            }

            :host(.opening),
            :host(.opening) x-tile {
                animation-duration: var(--faster);
                animation-timing-function: ease-out;
                animation-name: opening;

                opacity: 0;
                max-height: 0;
                max-width: 0;
                transform: scale(0);
            }

            @keyframes opening {
                from  {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                    max-height: var(--big-tile-h);
                    max-width: var(--big-tile-w);
                    transform: scale(1);
                }
            }

            input {
                display: none;
            }

            #close {
                display: none;
            }

            :host(.editing) input,
            :host(.editing) #close {
                display: inline-block;
            }

            :host(.editing) h1 {
                display: none;
            }

            x-tile {
                height: 100%;
                width: 100%;

                align-items: center;
                justify-items: center;
            }

            #leftside, #rightside {
                height: 100%;
                min-width: var(--small);
                flex-grow: 0;
            }

            #center {
                flex-grow: 1;
            }

            #center h1 {
                user-select: none;
            }

            #close  {
                margin: var(--margin);
            }
        </style>
        <x-tile>
            <x-vbox id="leftside">
                &nbsp;
            </x-vbox>
            <x-vbox id="center">
                <input name="name" placeholder="(package name)"/>
                <h1></h1>
            </x-vbox>
            <x-vbox id="rightside">
                <x-button id="close" class="sm-round"><x-svg src="svg/x.svg"></x-svg></x-button>
            </x-vbox>
        </x-tile>
        <script>
            class RcPackageTile extends RcElement {
                mappedAttributes = {"editing":"editing"}
                constructor() {
                    super();

                    this.sq('input').addEventListener('keyup', e => {
                        if (!this.classList.contains('editing')) {
                            return;
                        }

                        switch (e.key) {
                            case 'Escape': {
                                this.endEditing(true);
                            } break;

                            case 'Enter': {
                                this.endEditing();
                            } break;

                            default: {
                                return;
                            }
                        }

                        e.preventDefault();

                        return false;
                    });

                    this.sq('#close').addEventListener('click', e => {
                        this.endEditing(true);
                    });

                    this.addEventListener('click', e => {
                        if (!this.classList.contains('editing')) {
                            this.fireEvent('rc.openPackage', {package: this.package});
                        }
                    });

                    this.addEventListener('animationend', e => {
                        if (e.animationName == 'closing') {
                            this.parentElement.removeChild(this);
                        }

                        this.classList.remove(e.animationName);
                    });
                }

                get package() {
                    return this._package;
                }

                set package(newPackage) {
                    this._package = newPackage;
                    this._syncDisplay();
                }

                endEditing(cancel=false) {
                    if (cancel) {
                        if (!this.package) {
                            this.classList.add('closing');
                            return;
                        }
                    } else {
                        const rcPackages = this.closestElement('rc-packages');
                        const packageName = this.sq('input[name=name]').value;

                        if (!this.package) {
                            this.package = rcPackages.host.createPackage(packageName);
                        } else {
                            // !!!TBD!!! rename the package
                        }
                    }

                    this.classList.remove('new');
                    this.classList.remove('editing');
                }

                _syncDisplay() {
                    this.sq('input').value = this.package.name;
                    this.sq('h1').innerText = this.package.name;
                }
            }
        </script>
    </template>

    <template name="rc-packages">
        <style>
            :host {
                display: block;
                width: 100%;
            }

            x-tiles  {
                width: 100%;
                flex-wrap: wrap;
            }

            x-tile, rc-package-tile {
                display: flex;
                width: var(--big-tile-w);
                height: var(--big-tile-h);
                border: var(--med) solid var(--border);
                box-shadow: var(--card-shadow);

                margin: 1em;
            }

            rc-package-tile:hover {
                background: var(--focus-bg);
            }

            rc-package-tile:active {
                box-shadow: none;
            }

            rc-package-tile.editing:hover {
                background: inherit;
            }

            .addnew  {
                align-items: center;
                justify-content: center;
            }

            .addnew x-svg {
                fill: #fff;
            }

        </style>
        <x-tiles>
            <x-tile class="addnew">
                <x-button class="lg-round">
                    <x-svg src="svg/plus.svg"></x-svg>
                </x-button>
            </x-tile>
        </x-tiles>
        <script>
            class RcPackages extends RcElement {
                constructor() {
                    super();

                    const addNewTile = this.sq('x-tile.addnew');

                    addNewTile.addEventListener('click', e => {
                        if (this.sq('rc-package-tile.new')) {
                            return;
                        }

                        const newPackage = document.createElement('rc-package-tile');

                        newPackage.classList.add('editing');
                        newPackage.classList.add('new');
                        this.insertPackage(newPackage);
                    });
                }

                get host() {
                    return this._host;
                }

                set host(newHost) {
                    this._host = newHost;

                    this._syncDisplay();
                }

                _syncDisplay() {
                    for (const pkg in this.host.packages) {
                        const newPackage = document.createElement('rc-package-tile');

                        newPackage.package = pkg;
                        this.insertPackage(newPackage);
                    }
                }

                insertPackage(pkg) {
                    const addNewTile = this.sq('x-tile.addnew');

                    pkg.classList.add('opening');
                    this.sq('x-tiles').insertBefore(pkg, addNewTile);
                }
            }
        </script>
    </template>
</ph-components>
